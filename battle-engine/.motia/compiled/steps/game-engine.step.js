import { connectDB } from "../src/db.js";
import { MatchModel } from "../src/models/Match.js";
const config = {
  name: "GameEngine",
  type: "event",
  subscribes: ["player.joined", "code.processed"],
  emits: ["match.started"],
  flows: ["CodeDuelFlow"]
};
const handler = async (event, context) => {
  const { streams, logger, topic, emit } = context;
  await connectDB();
  const payload = event.data || event;
  const matchId = payload.matchId;
  if (!matchId) {
    logger.error("ENGINE: Missing matchId in event", payload);
    return;
  }
  const isJoinEvent = topic === "player.joined" || payload.playerId && !payload.action;
  const isCodeEvent = topic === "code.processed" || payload.action !== void 0;
  if (isJoinEvent) {
    const preMatch = await MatchModel.findOne({ matchId });
    if (preMatch && preMatch.status === "WAITING" && preMatch.players.length >= 2) {
      logger.info(`ENGINE: Match ${matchId} has 2 players. Starting Race...`);
      const now = Date.now();
      const endTime = now + preMatch.duration;
      const updatedGame = await MatchModel.findOneAndUpdate(
        { matchId, status: "WAITING" },
        { $set: { status: "RACING", startTime: now, endTime } },
        { new: true }
      );
      if (updatedGame) {
        logger.info(`RACE STARTED! Ends at: ${new Date(endTime).toISOString()}`);
        if (streams.match) {
          await streams.match.set(matchId, "message", {
            type: "START_RACE",
            startTime: now,
            endTime
          });
        }
        await emit({
          topic: "match.started",
          data: { matchId, duration: preMatch.duration }
        });
      }
    }
  }
  if (isCodeEvent) {
    const result = payload;
    logger.info(`ENGINE: Result for ${matchId} (${result.action}) - Success: ${result.success}`);
    if (streams.match) {
      await streams.match.set(matchId, "message", {
        type: "CODE_FEEDBACK",
        playerId: result.playerId,
        action: result.action,
        success: result.success,
        error: result.error,
        results: result.results,
        timestamp: Date.now()
      });
    }
    if (result.action === "SUBMIT_SOLUTION" && result.success) {
      const winningGame = await MatchModel.findOneAndUpdate(
        { matchId, status: "RACING" },
        { $set: { status: "FINISHED", winnerId: result.playerId } },
        { new: true }
      );
      if (winningGame) {
        logger.info(`MATCH FINISHED! Winner is ${result.playerId}`);
        if (streams.match) {
          await streams.match.set(matchId, "message", {
            type: "GAME_OVER",
            winner: result.playerId,
            reason: "SOLVED"
          });
        }
      }
    }
  }
};
export {
  config,
  handler
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vc3RlcHMvZ2FtZS1lbmdpbmUuc3RlcC50cyJdLAogICJzb3VyY2VzQ29udGVudCI6IFsiaW1wb3J0IHsgU3RlcENvbmZpZyB9IGZyb20gJ21vdGlhJztcclxuaW1wb3J0IHsgY29ubmVjdERCIH0gZnJvbSAnLi4vc3JjL2RiJztcclxuaW1wb3J0IHsgTWF0Y2hNb2RlbCB9IGZyb20gJy4uL3NyYy9tb2RlbHMvTWF0Y2gnO1xyXG5cclxuZXhwb3J0IGNvbnN0IGNvbmZpZzogU3RlcENvbmZpZyA9IHtcclxuICBuYW1lOiAnR2FtZUVuZ2luZScsXHJcbiAgdHlwZTogJ2V2ZW50JyxcclxuICBzdWJzY3JpYmVzOiBbJ3BsYXllci5qb2luZWQnLCAnY29kZS5wcm9jZXNzZWQnXSxcclxuICBlbWl0czogWydtYXRjaC5zdGFydGVkJ10sXHJcbiAgZmxvd3M6IFsnQ29kZUR1ZWxGbG93J11cclxufTtcclxuXHJcbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKGV2ZW50OiBhbnksIGNvbnRleHQ6IGFueSkgPT4ge1xyXG4gIGNvbnN0IHsgc3RyZWFtcywgbG9nZ2VyLCB0b3BpYywgZW1pdCB9ID0gY29udGV4dDsgXHJcbiAgYXdhaXQgY29ubmVjdERCKCk7XHJcbiAgXHJcbiAgY29uc3QgcGF5bG9hZCA9IGV2ZW50LmRhdGEgfHwgZXZlbnQ7IFxyXG4gIGNvbnN0IG1hdGNoSWQgPSBwYXlsb2FkLm1hdGNoSWQ7XHJcblxyXG4gIGlmICghbWF0Y2hJZCkge1xyXG4gICAgbG9nZ2VyLmVycm9yKFwiRU5HSU5FOiBNaXNzaW5nIG1hdGNoSWQgaW4gZXZlbnRcIiwgcGF5bG9hZCk7XHJcbiAgICByZXR1cm47XHJcbiAgfVxyXG5cclxuICBjb25zdCBpc0pvaW5FdmVudCA9ICh0b3BpYyA9PT0gJ3BsYXllci5qb2luZWQnKSB8fCAocGF5bG9hZC5wbGF5ZXJJZCAmJiAhcGF5bG9hZC5hY3Rpb24pO1xyXG4gIGNvbnN0IGlzQ29kZUV2ZW50ID0gKHRvcGljID09PSAnY29kZS5wcm9jZXNzZWQnKSB8fCAocGF5bG9hZC5hY3Rpb24gIT09IHVuZGVmaW5lZCk7XHJcblxyXG4gIGlmIChpc0pvaW5FdmVudCkge1xyXG4gICAgY29uc3QgcHJlTWF0Y2ggPSBhd2FpdCBNYXRjaE1vZGVsLmZpbmRPbmUoeyBtYXRjaElkIH0pO1xyXG5cclxuICAgIGlmIChwcmVNYXRjaCAmJiBwcmVNYXRjaC5zdGF0dXMgPT09ICdXQUlUSU5HJyAmJiBwcmVNYXRjaC5wbGF5ZXJzLmxlbmd0aCA+PSAyKSB7XHJcbiAgICAgICAgbG9nZ2VyLmluZm8oYEVOR0lORTogTWF0Y2ggJHttYXRjaElkfSBoYXMgMiBwbGF5ZXJzLiBTdGFydGluZyBSYWNlLi4uYCk7XHJcblxyXG4gICAgICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XHJcbiAgICAgICAgY29uc3QgZW5kVGltZSA9IG5vdyArIHByZU1hdGNoLmR1cmF0aW9uO1xyXG5cclxuICAgICAgICBjb25zdCB1cGRhdGVkR2FtZSA9IGF3YWl0IE1hdGNoTW9kZWwuZmluZE9uZUFuZFVwZGF0ZShcclxuICAgICAgICAgICAgeyBtYXRjaElkLCBzdGF0dXM6ICdXQUlUSU5HJyB9LFxyXG4gICAgICAgICAgICB7ICRzZXQ6IHsgc3RhdHVzOiAnUkFDSU5HJywgc3RhcnRUaW1lOiBub3csIGVuZFRpbWU6IGVuZFRpbWUgfSB9LFxyXG4gICAgICAgICAgICB7IG5ldzogdHJ1ZSB9XHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgaWYgKHVwZGF0ZWRHYW1lKSB7XHJcbiAgICAgICAgICAgICBsb2dnZXIuaW5mbyhgUkFDRSBTVEFSVEVEISBFbmRzIGF0OiAke25ldyBEYXRlKGVuZFRpbWUpLnRvSVNPU3RyaW5nKCl9YCk7XHJcblxyXG4gICAgICAgICAgICAgaWYgKHN0cmVhbXMubWF0Y2gpIHtcclxuICAgICAgICAgICAgICAgIGF3YWl0IHN0cmVhbXMubWF0Y2guc2V0KG1hdGNoSWQsICdtZXNzYWdlJywgeyBcclxuICAgICAgICAgICAgICAgICAgICB0eXBlOiAnU1RBUlRfUkFDRScsIFxyXG4gICAgICAgICAgICAgICAgICAgIHN0YXJ0VGltZTogbm93LCBcclxuICAgICAgICAgICAgICAgICAgICBlbmRUaW1lOiBlbmRUaW1lIFxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgYXdhaXQgZW1pdCh7IFxyXG4gICAgICAgICAgICAgICAgIHRvcGljOiAnbWF0Y2guc3RhcnRlZCcsIFxyXG4gICAgICAgICAgICAgICAgIGRhdGE6IHsgbWF0Y2hJZCwgZHVyYXRpb246IHByZU1hdGNoLmR1cmF0aW9uIH0gXHJcbiAgICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBpZiAoaXNDb2RlRXZlbnQpIHtcclxuICAgICBjb25zdCByZXN1bHQgPSBwYXlsb2FkOyBcclxuICAgICBsb2dnZXIuaW5mbyhgRU5HSU5FOiBSZXN1bHQgZm9yICR7bWF0Y2hJZH0gKCR7cmVzdWx0LmFjdGlvbn0pIC0gU3VjY2VzczogJHtyZXN1bHQuc3VjY2Vzc31gKTtcclxuXHJcbiAgICAgaWYgKHN0cmVhbXMubWF0Y2gpIHtcclxuICAgICAgICAgYXdhaXQgc3RyZWFtcy5tYXRjaC5zZXQobWF0Y2hJZCwgJ21lc3NhZ2UnLCB7IFxyXG4gICAgICAgICAgICB0eXBlOiAnQ09ERV9GRUVEQkFDSycsXHJcbiAgICAgICAgICAgIHBsYXllcklkOiByZXN1bHQucGxheWVySWQsXHJcbiAgICAgICAgICAgIGFjdGlvbjogcmVzdWx0LmFjdGlvbixcclxuICAgICAgICAgICAgc3VjY2VzczogcmVzdWx0LnN1Y2Nlc3MsXHJcbiAgICAgICAgICAgIGVycm9yOiByZXN1bHQuZXJyb3IsXHJcbiAgICAgICAgICAgIHJlc3VsdHM6IHJlc3VsdC5yZXN1bHRzLFxyXG4gICAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KClcclxuICAgICAgICAgfSk7XHJcbiAgICAgfVxyXG5cclxuICAgICBpZiAocmVzdWx0LmFjdGlvbiA9PT0gJ1NVQk1JVF9TT0xVVElPTicgJiYgcmVzdWx0LnN1Y2Nlc3MpIHtcclxuICAgICAgICBjb25zdCB3aW5uaW5nR2FtZSA9IGF3YWl0IE1hdGNoTW9kZWwuZmluZE9uZUFuZFVwZGF0ZShcclxuICAgICAgICAgICAgeyBtYXRjaElkLCBzdGF0dXM6ICdSQUNJTkcnIH0sXHJcbiAgICAgICAgICAgIHsgJHNldDogeyBzdGF0dXM6ICdGSU5JU0hFRCcsIHdpbm5lcklkOiByZXN1bHQucGxheWVySWQgfSB9LFxyXG4gICAgICAgICAgICB7IG5ldzogdHJ1ZSB9XHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgaWYgKHdpbm5pbmdHYW1lKSB7XHJcbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGBNQVRDSCBGSU5JU0hFRCEgV2lubmVyIGlzICR7cmVzdWx0LnBsYXllcklkfWApO1xyXG4gICAgICAgICAgICBpZiAoc3RyZWFtcy5tYXRjaCkge1xyXG4gICAgICAgICAgICAgICAgYXdhaXQgc3RyZWFtcy5tYXRjaC5zZXQobWF0Y2hJZCwgJ21lc3NhZ2UnLCB7IFxyXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdHQU1FX09WRVInLCBcclxuICAgICAgICAgICAgICAgICAgICB3aW5uZXI6IHJlc3VsdC5wbGF5ZXJJZCxcclxuICAgICAgICAgICAgICAgICAgICByZWFzb246ICdTT0xWRUQnXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICB9XHJcbiAgfVxyXG59OyJdLAogICJtYXBwaW5ncyI6ICJBQUNBLFNBQVMsaUJBQWlCO0FBQzFCLFNBQVMsa0JBQWtCO0FBRXBCLE1BQU0sU0FBcUI7QUFBQSxFQUNoQyxNQUFNO0FBQUEsRUFDTixNQUFNO0FBQUEsRUFDTixZQUFZLENBQUMsaUJBQWlCLGdCQUFnQjtBQUFBLEVBQzlDLE9BQU8sQ0FBQyxlQUFlO0FB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
