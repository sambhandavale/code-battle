import { connectDB } from "../src/db.js";
import { MatchModel } from "../src/models/Match.js";
import Question from "../src/models/Question.js";
const config = {
  name: "CodeRunner",
  type: "event",
  subscribes: ["run.code"],
  emits: ["code.processed"],
  flows: ["CodeDuelFlow"]
};
var Verdict = /* @__PURE__ */ ((Verdict2) => {
  Verdict2["ACCEPTED"] = "Accepted";
  Verdict2["WRONG_ANSWER"] = "Wrong Answer";
  Verdict2["COMPILE_ERROR"] = "Compilation Error";
  Verdict2["RUNTIME_ERROR"] = "Runtime Error";
  return Verdict2;
})(Verdict || {});
const handler = async (event, { emit, logger }) => {
  await connectDB();
  const data = event.data || event;
  const { matchId, playerId, code, action, language = "python", version = "3.10.0" } = data;
  let success = true;
  let errorMsg = void 0;
  try {
    const match = await MatchModel.findOne({ matchId });
    if (!match) throw new Error("Match not found");
    const question = await Question.findById(match.problemId);
    if (!question) throw new Error("Question not found");
    logger.info(`\u2696\uFE0F JUDGE: Evaluator started for ${playerId} on '${question.title}' (${question.test_cases.length} cases)`);
    for (let i = 0; i < question.test_cases.length; i++) {
      const testCase = question.test_cases[i];
      const result = await runPiston(code, language, version, testCase);
      if (result.status !== "Accepted" /* ACCEPTED */) {
        success = false;
        errorMsg = `Test Case ${i + 1} Failed: ${result.status}`;
        if (result.output) errorMsg += ` (Output: ${result.output})`;
        if (result.stderr) errorMsg += ` (Error: ${result.stderr})`;
        logger.warn(`\u274C ${playerId}: ${errorMsg}`);
        break;
      }
    }
  } catch (err) {
    success = false;
    errorMsg = `System Error: ${err.message}`;
    logger.error(errorMsg);
  }
  logger.info(`\u2696\uFE0F VERDICT for ${playerId}: ${success ? "PASSED ALL" : "FAILED"}`);
  const resultData = {
    matchId,
    playerId,
    action,
    success,
    error: errorMsg
  };
  await emit({ topic: "code.processed", data: resultData });
};
async function runPiston(code, language, version, testCase) {
  const payload = {
    language,
    version,
    files: [{ name: "main", content: code }],
    stdin: testCase.input,
    run_timeout: 3e3,
    compile_timeout: 1e4
  };
  try {
    const response = await fetch("https://emkc.org/api/v2/piston/execute", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const data = await response.json();
    if (data.compile && data.compile.code !== 0) return { status: "Compilation Error" /* COMPILE_ERROR */, stderr: data.compile.stderr };
    if (data.run && data.run.code !== 0) return { status: "Runtime Error" /* RUNTIME_ERROR */, stderr: data.run.stderr };
    const actual = (data.run.stdout || "").trim();
    const expected = testCase.output.map((o) => o.trim());
    const isCorrect = expected.includes(actual);
    return {
      status: isCorrect ? "Accepted" /* ACCEPTED */ : "Wrong Answer" /* WRONG_ANSWER */,
      output: actual
    };
  } catch (e) {
    return { status: "Runtime Error" /* RUNTIME_ERROR */, stderr: "API Fail" };
  }
}
export {
  config,
  handler
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vY29kZS1ydW5uZXIuc3RlcC50cyJdLAogICJzb3VyY2VzQ29udGVudCI6IFsiaW1wb3J0IHsgU3RlcENvbmZpZyB9IGZyb20gJ21vdGlhJztcclxuaW1wb3J0IHsgY29ubmVjdERCIH0gZnJvbSAnLi4vc3JjL2RiJztcclxuaW1wb3J0IHsgTWF0Y2hNb2RlbCB9IGZyb20gJy4uL3NyYy9tb2RlbHMvTWF0Y2gnO1xyXG5pbXBvcnQgeyBSdW5uZXJSZXF1ZXN0LCBSdW5uZXJSZXN1bHQgfSBmcm9tICcuLi9zcmMvdHlwZXMnO1xyXG5pbXBvcnQgUXVlc3Rpb24gZnJvbSAnLi4vc3JjL21vZGVscy9RdWVzdGlvbic7XHJcblxyXG5leHBvcnQgY29uc3QgY29uZmlnOiBTdGVwQ29uZmlnID0ge1xyXG4gIG5hbWU6ICdDb2RlUnVubmVyJyxcclxuICB0eXBlOiAnZXZlbnQnLFxyXG4gIHN1YnNjcmliZXM6IFsncnVuLmNvZGUnXSxcclxuICBlbWl0czogWydjb2RlLnByb2Nlc3NlZCddLFxyXG4gIGZsb3dzOiBbJ0NvZGVEdWVsRmxvdyddXHJcbn07XHJcblxyXG5lbnVtIFZlcmRpY3Qge1xyXG4gIEFDQ0VQVEVEID0gXCJBY2NlcHRlZFwiLFxyXG4gIFdST05HX0FOU1dFUiA9IFwiV3JvbmcgQW5zd2VyXCIsXHJcbiAgQ09NUElMRV9FUlJPUiA9IFwiQ29tcGlsYXRpb24gRXJyb3JcIixcclxuICBSVU5USU1FX0VSUk9SID0gXCJSdW50aW1lIEVycm9yXCIsXHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKGV2ZW50OiBhbnksIHsgZW1pdCwgbG9nZ2VyIH06IGFueSkgPT4ge1xyXG4gIGF3YWl0IGNvbm5lY3REQigpOyAvLyBNdXN0IGNvbm5lY3Qgc2luY2Ugd2UgcXVlcnkgREIgbm93XHJcblxyXG4gIGNvbnN0IGRhdGEgPSAoZXZlbnQuZGF0YSB8fCBldmVudCkgYXMgUnVubmVyUmVxdWVzdCAmIHsgbGFuZ3VhZ2U/OiBzdHJpbmcsIHZlcnNpb24/OiBzdHJpbmcgfTtcclxuICBjb25zdCB7IG1hdGNoSWQsIHBsYXllcklkLCBjb2RlLCBhY3Rpb24sIGxhbmd1YWdlID0gXCJweXRob25cIiwgdmVyc2lvbiA9IFwiMy4xMC4wXCIgfSA9IGRhdGE7XHJcblxyXG4gIGxldCBzdWNjZXNzID0gdHJ1ZTtcclxuICBsZXQgZXJyb3JNc2cgPSB1bmRlZmluZWQ7XHJcblxyXG4gIHRyeSB7XHJcbiAgICAvLyAxLiBGaW5kIHRoZSBQcm9ibGVtIElEIGZyb20gdGhlIE1hdGNoXHJcbiAgICBjb25zdCBtYXRjaCA9IGF3YWl0IE1hdGNoTW9kZWwuZmluZE9uZSh7IG1hdGNoSWQgfSk7XHJcbiAgICBpZiAoIW1hdGNoKSB0aHJvdyBuZXcgRXJyb3IoXCJNYXRjaCBub3QgZm91bmRcIik7XHJcblxyXG4gICAgLy8gMi4gRmV0Y2ggdGhlIFF1ZXN0aW9uIGFuZCBUZXN0IENhc2VzXHJcbiAgICBjb25zdCBxdWVzdGlvbiA9IGF3YWl0IFF1ZXN0aW9uLmZpbmRCeUlkKG1hdGNoLnByb2JsZW1JZCk7XHJcbiAgICBpZiAoIXF1ZXN0aW9uKSB0aHJvdyBuZXcgRXJyb3IoXCJRdWVzdGlvbiBub3QgZm91bmRcIik7XHJcblxyXG4gICAgbG9nZ2VyLmluZm8oYFx1MjY5Nlx1RkUwRiBKVURHRTogRXZhbHVhdG9yIHN0YXJ0ZWQgZm9yICR7cGxheWVySWR9IG9uICcke3F1ZXN0aW9uLnRpdGxlfScgKCR7cXVlc3Rpb24udGVzdF9jYXNlcy5sZW5ndGh9IGNhc2VzKWApO1xyXG5cclxuICAgIC8vIDMuIFJ1biBUZXN0IENhc2VzXHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHF1ZXN0aW9uLnRlc3RfY2FzZXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBjb25zdCB0ZXN0Q2FzZSA9IHF1ZXN0aW9uLnRlc3RfY2FzZXNbaV07XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNhbGwgUGlzdG9uXHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcnVuUGlzdG9uKGNvZGUsIGxhbmd1YWdlLCB2ZXJzaW9uLCB0ZXN0Q2FzZSk7XHJcblxyXG4gICAgICAgIGlmIChyZXN1bHQuc3RhdHVzICE9PSBWZXJkaWN0LkFDQ0VQVEVEKSB7XHJcbiAgICAgICAgICAgIHN1Y2Nlc3MgPSBmYWxzZTtcclxuICAgICAgICAgICAgZXJyb3JNc2cgPSBgVGVzdCBDYXNlICR7aSArIDF9IEZhaWxlZDogJHtyZXN1bHQuc3RhdHVzfWA7XHJcbiAgICAgICAgICAgIGlmIChyZXN1bHQub3V0cHV0KSBlcnJvck1zZyArPSBgIChPdXRwdXQ6ICR7cmVzdWx0Lm91dHB1dH0pYDtcclxuICAgICAgICAgICAgaWYgKHJlc3VsdC5zdGRlcnIpIGVycm9yTXNnICs9IGAgKEVycm9yOiAke3Jlc3VsdC5zdGRlcnJ9KWA7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBsb2dnZXIud2FybihgXHUyNzRDICR7cGxheWVySWR9OiAke2Vycm9yTXNnfWApO1xyXG4gICAgICAgICAgICBicmVhazsgXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICB9IGNhdGNoIChlcnI6IGFueSkge1xyXG4gICAgc3VjY2VzcyA9IGZhbHNlO1xyXG4gICAgZXJyb3JNc2cgPSBgU3lzdGVtIEVycm9yOiAke2Vyci5tZXNzYWdlfWA7XHJcbiAgICBsb2dnZXIuZXJyb3IoZXJyb3JNc2cpO1xyXG4gIH1cclxuXHJcbiAgbG9nZ2VyLmluZm8oYFx1MjY5Nlx1RkUwRiBWRVJESUNUIGZvciAke3BsYXllcklkfTogJHtzdWNjZXNzID8gXCJQQVNTRUQgQUxMXCIgOiBcIkZBSUxFRFwifWApO1xyXG5cclxuICAvLyA0LiBSZXBvcnQgUmVzdWx0XHJcbiAgY29uc3QgcmVzdWx0RGF0YTogUnVubmVyUmVzdWx0ID0ge1xyXG4gICAgbWF0Y2hJZCxcclxuICAgIHBsYXllcklkLFxyXG4gICAgYWN0aW9uOiBhY3Rpb24gYXMgJ1JVTl9URVNUUycgfCAnU1VCTUlUX1NPTFVUSU9OJyxcclxuICAgIHN1Y2Nlc3MsXHJcbiAgICBlcnJvcjogZXJyb3JNc2dcclxuICB9O1xyXG5cclxuICBhd2FpdCBlbWl0KHsgdG9waWM6ICdjb2RlLnByb2Nlc3NlZCcsIGRhdGE6IHJlc3VsdERhdGEgfSk7XHJcbn07XHJcblxyXG4vLyAtLS0gUGlzdG9uIEhlbHBlciAtLS1cclxuYXN5bmMgZnVuY3Rpb24gcnVuUGlzdG9uKGNvZGU6IHN0cmluZywgbGFuZ3VhZ2U6IHN0cmluZywgdmVyc2lvbjogc3RyaW5nLCB0ZXN0Q2FzZTogYW55KSB7XHJcbiAgICBjb25zdCBwYXlsb2FkID0ge1xyXG4gICAgICAgIGxhbmd1YWdlLFxyXG4gICAgICAgIHZlcnNpb24sXHJcbiAgICAgICAgZmlsZXM6IFt7IG5hbWU6ICdtYWluJywgY29udGVudDogY29kZSB9XSxcclxuICAgICAgICBzdGRpbjogdGVzdENhc2UuaW5wdXQsXHJcbiAgICAgICAgcnVuX3RpbWVvdXQ6IDMwMDAsXHJcbiAgICAgICAgY29tcGlsZV90aW1lb3V0OiAxMDAwMCxcclxuICAgIH07XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKFwiaHR0cHM6Ly9lbWtjLm9yZy9hcGkvdjIvcGlzdG9uL2V4ZWN1dGVcIiwge1xyXG4gICAgICAgICAgICBtZXRob2Q6IFwiUE9TVFwiLFxyXG4gICAgICAgICAgICBoZWFkZXJzOiB7IFwiQ29udGVudC1UeXBlXCI6IFwiYXBwbGljYXRpb24vanNvblwiIH0sXHJcbiAgICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHBheWxvYWQpLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGNvbnN0IGRhdGE6IGFueSA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTtcclxuXHJcbiAgICAgICAgaWYgKGRhdGEuY29tcGlsZSAmJiBkYXRhLmNvbXBpbGUuY29kZSAhPT0gMCkgcmV0dXJuIHsgc3RhdHVzOiBWZXJkaWN0LkNPTVBJTEVfRVJST1IsIHN0ZGVycjogZGF0YS5jb21waWxlLnN0ZGVyciB9O1xyXG4gICAgICAgIGlmIChkYXRhLnJ1biAmJiBkYXRhLnJ1bi5jb2RlICE9PSAwKSByZXR1cm4geyBzdGF0dXM6IFZlcmRpY3QuUlVOVElNRV9FUlJPUiwgc3RkZXJyOiBkYXRhLnJ1bi5zdGRlcnIgfTtcclxuXHJcbiAgICAgICAgY29uc3QgYWN0dWFsID0gKGRhdGEucnVuLnN0ZG91dCB8fCBcIlwiKS50cmltKCk7XHJcbiAgICAgICAgY29uc3QgZXhwZWN0ZWQgPSB0ZXN0Q2FzZS5vdXRwdXQubWFwKChvOiBzdHJpbmcpID0+IG8udHJpbSgpKTtcclxuICAgICAgICBcclxuICAgICAgICAvLyBDaGVjayBpZiBvdXRwdXQgbWF0Y2hlcyBBTlkgb2YgdGhlIHZhbGlkIG91dHB1dHNcclxuICAgICAgICBjb25zdCBpc0NvcnJlY3QgPSBleHBlY3RlZC5pbmNsdWRlcyhhY3R1YWwpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHJldHVybiB7IFxyXG4gICAgICAgICAgICBzdGF0dXM6IGlzQ29ycmVjdCA/IFZlcmRpY3QuQUNDRVBURUQgOiBWZXJkaWN0LldST05HX0FOU1dFUiwgXHJcbiAgICAgICAgICAgIG91dHB1dDogYWN0dWFsIFxyXG4gICAgICAgIH07XHJcblxyXG4gICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgIHJldHVybiB7IHN0YXR1czogVmVyZGljdC5SVU5USU1FX0VSUk9SLCBzdGRlcnI6IFwiQVBJIEZhaWxcIiB9O1xyXG4gICAgfVxyXG59Il0sCiAgIm1hcHBpbmdzIjogIkFBQ0EsU0FBUyxpQkFBaUI7QUFDMUIsU0FBUyxrQkFBa0I7QUFFM0IsT0FBTyxjQUFjO0FBRWQsTUFBTSxTQUFxQjtBQUFBLEVBQ2hDLE1BQU07QUFBQSxFQUNOLE1BQU07QUFBQSxFQUNOLFlBQVksQ0FBQyxVQUFVO0FBQUEsRUFDdkIsT0FBTyxDQUFDLGdCQUFnQjtBQUFBLEVBQ3hCLE9BQU8sQ0FBQyxjQUFjO0FBQ3hCO0FBRUEsSUFBSyxVQUFMLGtCQUFLQSxhQUFMO0FBQ0UsRUFBQUEsU0FBQSxjQUFXO0FBQ1gsRUFBQUEsU0FBQSxrQkFBZTtBQUNmLEVBQUFBLFNBQUEsbUJBQWdCO0FBQ2hCLEVBQUFBLFNBQUEsbUJBQWdCO0FBSmIsU0FBQUE7QUFBQSxHQUFBO0FBT0UsTUFBTSxVQUFVLE9BQU8sT0FBWSxFQUFFLE1BQU0sT0FBTyxNQUFXO0FBQ2xFLFFBQU0sVUFBVTtBQUVoQixRQUFNLE9BQVEsTUFBTSxRQUFRO0FBQzVCLFFBQU0sRUFBRSxTQUFTLFVBQVUsTUFBTSxRQUFRLFdBQVcsVUFBVSxVQUFVLFNBQVMsSUFBSTtBQUVyRixNQUFJLFVBQVU7QUFDZCxNQUFJLFdBQVc7QUFFZixNQUFJO0FBRUYsVUFBTSxRQUFRLE1BQU0sV0FBVyxRQUFRLEVBQUUsUUFBUSxDQUFDO0FBQ2xELFFBQUksQ0FBQyxNQUFPLE9BQU0sSUFBSSxNQUFNLGlCQUFpQjtBQUc3QyxVQUFNLFdBQVcsTUFBTSxTQUFTLFNBQVMsTUFBTSxTQUFTO0FBQ3hELFFBQUksQ0FBQyxTQUFVLE9BQU0sSUFBSSxNQUFNLG9CQUFvQjtBQUVuRCxXQUFPLEtBQUssNkNBQW1DLFFBQVEsUUFBUSxTQUFTLEtBQUssTUFBTSxTQUFTLFdBQVcsTUFBTSxTQUFTO0FBR3RILGFBQVMsSUFBSSxHQUFHLElBQUksU0FBUyxXQUFXLFFBQVEsS0FBSztBQUNqRCxZQUFNLFdBQVcsU0FBUyxXQUFXLENBQUM7QUFHdEMsWUFBTSxTQUFTLE1BQU0sVUFBVSxNQUFNLFVBQVUsU0FBUyxRQUFRO0FBRWhFLFVBQUksT0FBTyxXQUFXLDJCQUFrQjtBQUNwQyxrQkFBVTtBQUNWLG1CQUFXLGFBQWEsSUFBSSxDQUFDLFlBQVksT0FBTyxNQUFNO0FBQ3RELFlBQUksT0FBTyxPQUFRLGFBQVksYUFBYSxPQUFPLE1BQU07QUFDekQsWUFBSSxPQUFPLE9BQVEsYUFBWSxZQUFZLE9BQU8sTUFBTTtBQUV4RCxlQUFPLEtBQUssVUFBSyxRQUFRLEtBQUssUUFBUSxFQUFFO0FBQ3hDO0FBQUEsTUFDSjtBQUFBLElBQ0o7QUFBQSxFQUVGLFNBQVMsS0FBVTtBQUNqQixjQUFVO0FBQ1YsZUFBVyxpQkFBaUIsSUFBSSxPQUFPO0FBQ3ZDLFdBQU8sTUFBTSxRQUFRO0FBQUEsRUFDdkI7QUFFQSxTQUFPLEtBQUssNEJBQWtCLFFBQVEsS0FBSyxVQUFVLGVBQWUsUUFBUSxFQUFFO0FBRzlFLFFBQU0sYUFBMkI7QUFBQSxJQUMvQjtBQUFBLElBQ0E7QUFBQSxJQUNBO0FBQUEsSUFDQTtBQUFBLElBQ0EsT0FBTztBQUFBLEVBQ1Q7QUFFQSxRQUFNLEtBQUssRUFBRSxPQUFPLGtCQUFrQixNQUFNLFdBQVcsQ0FBQztBQUMxRDtBQUdBLGVBQWUsVUFBVSxNQUFjLFVBQWtCLFNBQWlCLFVBQWU7QUFDckYsUUFBTSxVQUFVO0FBQUEsSUFDWjtBQUFBLElBQ0E7QUFBQSxJQUNBLE9BQU8sQ0FBQyxFQUFFLE1BQU0sUUFBUSxTQUFTLEtBQUssQ0FBQztBQUFBLElBQ3ZDLE9BQU8sU0FBUztBQUFBLElBQ2hCLGFBQWE7QUFBQSxJQUNiLGlCQUFpQjtBQUFBLEVBQ3JCO0FBRUEsTUFBSTtBQUNBLFVBQU0sV0FBVyxNQUFNLE1BQU0sMENBQTBDO0FBQUEsTUFDbkUsUUFBUTtBQUFBLE1BQ1IsU0FBUyxFQUFFLGdCQUFnQixtQkFBbUI7QUFBQSxNQUM5QyxNQUFNLEtBQUssVUFBVSxPQUFPO0FBQUEsSUFDaEMsQ0FBQztBQUNELFVBQU0sT0FBWSxNQUFNLFNBQVMsS0FBSztBQUV0QyxRQUFJLEtBQUssV0FBVyxLQUFLLFFBQVEsU0FBUyxFQUFHLFFBQU8sRUFBRSxRQUFRLHlDQUF1QixRQUFRLEtBQUssUUFBUSxPQUFPO0FBQ2pILFFBQUksS0FBSyxPQUFPLEtBQUssSUFBSSxTQUFTLEVBQUcsUUFBTyxFQUFFLFFBQVEscUNBQXVCLFFBQVEsS0FBSyxJQUFJLE9BQU87QUFFckcsVUFBTSxVQUFVLEtBQUssSUFBSSxVQUFVLElBQUksS0FBSztBQUM1QyxVQUFNLFdBQVcsU0FBUyxPQUFPLElBQUksQ0FBQyxNQUFjLEVBQUUsS0FBSyxDQUFDO0FBRzVELFVBQU0sWUFBWSxTQUFTLFNBQVMsTUFBTTtBQUUxQyxXQUFPO0FBQUEsTUFDSCxRQUFRLFlBQVksNEJBQW1CO0FBQUEsTUFDdkMsUUFBUTtBQUFBLElBQ1o7QUFBQSxFQUVKLFNBQVMsR0FBRztBQUNSLFdBQU8sRUFBRSxRQUFRLHFDQUF1QixRQUFRLFdBQVc7QUFBQSxFQUMvRDtBQUNKOyIsCiAgIm5hbWVzIjogWyJWZXJkaWN0Il0KfQo=
