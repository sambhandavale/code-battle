import { connectDB } from "../src/db.js";
import { MatchModel } from "../src/models/Match.js";
const config = {
  name: "GameEngine",
  type: "event",
  subscribes: ["player.joined", "code.processed"],
  emits: [],
  flows: ["CodeDuelFlow"]
};
const handler = async (event, context) => {
  const { streams, logger, traceId, topic } = context;
  await connectDB();
  const payload = event.data || event;
  const matchId = payload.matchId;
  if (!matchId) {
    logger.error("\u274C ENGINE: Missing matchId", payload);
    return;
  }
  const isJoinEvent = topic === "player.joined" || payload.playerId && !payload.action;
  const isCodeEvent = topic === "code.processed" || payload.action !== void 0;
  if (isJoinEvent) {
    const preMatch = await MatchModel.findOne({ matchId });
    if (preMatch && preMatch.status === "WAITING" && preMatch.players.length >= 2) {
      const now = Date.now();
      const endTime = now + preMatch.duration;
      const updatedGame = await MatchModel.findOneAndUpdate(
        { matchId, status: "WAITING" },
        { $set: { status: "RACING", startTime: now, endTime } },
        { new: true }
      );
      if (updatedGame) {
        logger.info(`\u{1F680} RACE STARTED! Ends at: ${new Date(endTime).toISOString()}`);
        if (streams.match) {
          await streams.match.set(traceId || matchId, "message", {
            type: "START_RACE",
            startTime: now,
            endTime
          });
        }
      }
    }
  }
  if (isCodeEvent) {
    const result = payload;
    logger.info(`\u{1F3C1} ENGINE: Received Code Result for ${matchId}`, {
      player: result.playerId,
      success: result.success,
      action: result.action
    });
    if (result.action === "SUBMIT_SOLUTION" && result.success) {
      logger.info(`\u{1F3C6} Attempting to declare winner: ${result.playerId}...`);
      const winningGame = await MatchModel.findOneAndUpdate(
        { matchId, status: "RACING" },
        // Condition: Must be RACING
        { $set: { status: "FINISHED", winnerId: result.playerId } },
        { new: true }
      );
      if (winningGame) {
        logger.info(`\u{1F389} MATCH FINISHED! Winner is ${result.playerId}`);
        if (streams.match) {
          await streams.match.set(traceId || matchId, "message", {
            type: "GAME_OVER",
            winner: result.playerId
          });
        }
      } else {
        const currentMatch = await MatchModel.findOne({ matchId });
        logger.warn(`\u26A0\uFE0F WINNER UPDATE FAILED!`, {
          expectedStatus: "RACING",
          actualStatus: currentMatch?.status,
          matchId
        });
      }
    }
  }
};
export {
  config,
  handler
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vZ2FtZS1lbmdpbmUuc3RlcC50cyJdLAogICJzb3VyY2VzQ29udGVudCI6IFsiaW1wb3J0IHsgU3RlcENvbmZpZyB9IGZyb20gJ21vdGlhJztcclxuaW1wb3J0IHsgY29ubmVjdERCIH0gZnJvbSAnLi4vc3JjL2RiJztcclxuaW1wb3J0IHsgTWF0Y2hNb2RlbCB9IGZyb20gJy4uL3NyYy9tb2RlbHMvTWF0Y2gnO1xyXG5cclxuZXhwb3J0IGNvbnN0IGNvbmZpZzogU3RlcENvbmZpZyA9IHtcclxuICBuYW1lOiAnR2FtZUVuZ2luZScsXHJcbiAgdHlwZTogJ2V2ZW50JyxcclxuICBzdWJzY3JpYmVzOiBbJ3BsYXllci5qb2luZWQnLCAnY29kZS5wcm9jZXNzZWQnXSxcclxuICBlbWl0czogW10sXHJcbiAgZmxvd3M6IFsnQ29kZUR1ZWxGbG93J11cclxufTtcclxuXHJcbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKGV2ZW50OiBhbnksIGNvbnRleHQ6IGFueSkgPT4ge1xyXG4gIGNvbnN0IHsgc3RyZWFtcywgbG9nZ2VyLCB0cmFjZUlkLCB0b3BpYyB9ID0gY29udGV4dDsgXHJcbiAgYXdhaXQgY29ubmVjdERCKCk7XHJcbiAgXHJcbiAgY29uc3QgcGF5bG9hZCA9IGV2ZW50LmRhdGEgfHwgZXZlbnQ7IFxyXG4gIGNvbnN0IG1hdGNoSWQgPSBwYXlsb2FkLm1hdGNoSWQ7XHJcblxyXG4gIGlmICghbWF0Y2hJZCkge1xyXG4gICAgbG9nZ2VyLmVycm9yKFwiXHUyNzRDIEVOR0lORTogTWlzc2luZyBtYXRjaElkXCIsIHBheWxvYWQpO1xyXG4gICAgcmV0dXJuO1xyXG4gIH1cclxuXHJcbiAgLy8gUm9idXN0IFRvcGljIERldGVjdGlvblxyXG4gIGNvbnN0IGlzSm9pbkV2ZW50ID0gKHRvcGljID09PSAncGxheWVyLmpvaW5lZCcpIHx8IChwYXlsb2FkLnBsYXllcklkICYmICFwYXlsb2FkLmFjdGlvbik7XHJcbiAgY29uc3QgaXNDb2RlRXZlbnQgPSAodG9waWMgPT09ICdjb2RlLnByb2Nlc3NlZCcpIHx8IChwYXlsb2FkLmFjdGlvbiAhPT0gdW5kZWZpbmVkKTtcclxuXHJcbiAgLy8gLS0tIDEuIFNUQVJUIFJBQ0UgTE9HSUMgLS0tXHJcbiAgaWYgKGlzSm9pbkV2ZW50KSB7XHJcbiAgICBjb25zdCBwcmVNYXRjaCA9IGF3YWl0IE1hdGNoTW9kZWwuZmluZE9uZSh7IG1hdGNoSWQgfSk7XHJcbiAgICBpZiAocHJlTWF0Y2ggJiYgcHJlTWF0Y2guc3RhdHVzID09PSAnV0FJVElORycgJiYgcHJlTWF0Y2gucGxheWVycy5sZW5ndGggPj0gMikge1xyXG4gICAgICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XHJcbiAgICAgICAgY29uc3QgZW5kVGltZSA9IG5vdyArIHByZU1hdGNoLmR1cmF0aW9uO1xyXG5cclxuICAgICAgICBjb25zdCB1cGRhdGVkR2FtZSA9IGF3YWl0IE1hdGNoTW9kZWwuZmluZE9uZUFuZFVwZGF0ZShcclxuICAgICAgICAgICAgeyBtYXRjaElkLCBzdGF0dXM6ICdXQUlUSU5HJyB9LFxyXG4gICAgICAgICAgICB7ICRzZXQ6IHsgc3RhdHVzOiAnUkFDSU5HJywgc3RhcnRUaW1lOiBub3csIGVuZFRpbWU6IGVuZFRpbWUgfSB9LFxyXG4gICAgICAgICAgICB7IG5ldzogdHJ1ZSB9XHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgaWYgKHVwZGF0ZWRHYW1lKSB7XHJcbiAgICAgICAgICAgICBsb2dnZXIuaW5mbyhgXHVEODNEXHVERTgwIFJBQ0UgU1RBUlRFRCEgRW5kcyBhdDogJHtuZXcgRGF0ZShlbmRUaW1lKS50b0lTT1N0cmluZygpfWApO1xyXG4gICAgICAgICAgICAgaWYgKHN0cmVhbXMubWF0Y2gpIHtcclxuICAgICAgICAgICAgICAgIGF3YWl0IHN0cmVhbXMubWF0Y2guc2V0KHRyYWNlSWQgfHwgbWF0Y2hJZCwgJ21lc3NhZ2UnLCB7IFxyXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdTVEFSVF9SQUNFJywgc3RhcnRUaW1lOiBub3csIGVuZFRpbWU6IGVuZFRpbWUgXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyAtLS0gMi4gRklOSVNIIFJBQ0UgTE9HSUMgLS0tXHJcbiAgaWYgKGlzQ29kZUV2ZW50KSB7XHJcbiAgICAgY29uc3QgcmVzdWx0ID0gcGF5bG9hZDsgXHJcbiAgICAgbG9nZ2VyLmluZm8oYFx1RDgzQ1x1REZDMSBFTkdJTkU6IFJlY2VpdmVkIENvZGUgUmVzdWx0IGZvciAke21hdGNoSWR9YCwgeyBcclxuICAgICAgICAgcGxheWVyOiByZXN1bHQucGxheWVySWQsIFxyXG4gICAgICAgICBzdWNjZXNzOiByZXN1bHQuc3VjY2VzcywgXHJcbiAgICAgICAgIGFjdGlvbjogcmVzdWx0LmFjdGlvbiBcclxuICAgICB9KTtcclxuXHJcbiAgICAgaWYgKHJlc3VsdC5hY3Rpb24gPT09ICdTVUJNSVRfU09MVVRJT04nICYmIHJlc3VsdC5zdWNjZXNzKSB7XHJcbiAgICAgICAgbG9nZ2VyLmluZm8oYFx1RDgzQ1x1REZDNiBBdHRlbXB0aW5nIHRvIGRlY2xhcmUgd2lubmVyOiAke3Jlc3VsdC5wbGF5ZXJJZH0uLi5gKTtcclxuXHJcbiAgICAgICAgLy8gMS4gVHJ5IHRvIFVwZGF0ZVxyXG4gICAgICAgIGNvbnN0IHdpbm5pbmdHYW1lID0gYXdhaXQgTWF0Y2hNb2RlbC5maW5kT25lQW5kVXBkYXRlKFxyXG4gICAgICAgICAgICB7IG1hdGNoSWQsIHN0YXR1czogJ1JBQ0lORycgfSwgLy8gQ29uZGl0aW9uOiBNdXN0IGJlIFJBQ0lOR1xyXG4gICAgICAgICAgICB7ICRzZXQ6IHsgc3RhdHVzOiAnRklOSVNIRUQnLCB3aW5uZXJJZDogcmVzdWx0LnBsYXllcklkIH0gfSxcclxuICAgICAgICAgICAgeyBuZXc6IHRydWUgfVxyXG4gICAgICAgICk7XHJcblxyXG4gICAgICAgIC8vIDIuIERpZCBpdCB3b3JrP1xyXG4gICAgICAgIGlmICh3aW5uaW5nR2FtZSkge1xyXG4gICAgICAgICAgICBsb2dnZXIuaW5mbyhgXHVEODNDXHVERjg5IE1BVENIIEZJTklTSEVEISBXaW5uZXIgaXMgJHtyZXN1bHQucGxheWVySWR9YCk7XHJcbiAgICAgICAgICAgIGlmIChzdHJlYW1zLm1hdGNoKSB7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCBzdHJlYW1zLm1hdGNoLnNldCh0cmFjZUlkIHx8IG1hdGNoSWQsICdtZXNzYWdlJywgeyBcclxuICAgICAgICAgICAgICAgICAgICB0eXBlOiAnR0FNRV9PVkVSJywgd2lubmVyOiByZXN1bHQucGxheWVySWQgXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIDMuIERFQlVHR0lORyBGQUlMVVJFXHJcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRNYXRjaCA9IGF3YWl0IE1hdGNoTW9kZWwuZmluZE9uZSh7IG1hdGNoSWQgfSk7XHJcbiAgICAgICAgICAgIGxvZ2dlci53YXJuKGBcdTI2QTBcdUZFMEYgV0lOTkVSIFVQREFURSBGQUlMRUQhYCwge1xyXG4gICAgICAgICAgICAgICAgZXhwZWN0ZWRTdGF0dXM6ICdSQUNJTkcnLFxyXG4gICAgICAgICAgICAgICAgYWN0dWFsU3RhdHVzOiBjdXJyZW50TWF0Y2g/LnN0YXR1cyxcclxuICAgICAgICAgICAgICAgIG1hdGNoSWQ6IG1hdGNoSWRcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgIH1cclxuICB9XHJcbn07Il0sCiAgIm1hcHBpbmdzIjogIkFBQ0EsU0FBUyxpQkFBaUI7QUFDMUIsU0FBUyxrQkFBa0I7QUFFcEIsTUFBTSxTQUFxQjtBQUFBLEVBQ2hDLE1BQU07QUFBQSxFQUNOLE1BQU07QUFBQSxFQUNOLFlBQVksQ0FBQyxpQkFBaUIsZ0JBQWdCO0FBQUEsRUFDOUMsT0FBTyxD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
