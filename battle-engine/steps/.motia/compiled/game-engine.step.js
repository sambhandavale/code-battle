import { connectDB } from "../src/db.js";
import { MatchModel } from "../src/models/Match.js";
const config = {
  name: "GameEngine",
  type: "event",
  subscribes: ["player.joined", "code.processed"],
  emits: ["match.started"],
  // ðŸ‘ˆ NEW: Triggers the timer
  flows: ["CodeDuelFlow"]
};
const handler = async (event, context) => {
  const { streams, logger, topic, emit } = context;
  await connectDB();
  const payload = event.data || event;
  const matchId = payload.matchId;
  if (!matchId) {
    logger.error("ENGINE: Missing matchId in event", payload);
    return;
  }
  const isJoinEvent = topic === "player.joined" || payload.playerId && !payload.action;
  const isCodeEvent = topic === "code.processed" || payload.action !== void 0;
  if (isJoinEvent) {
    const preMatch = await MatchModel.findOne({ matchId });
    if (preMatch && preMatch.status === "WAITING" && preMatch.players.length >= 2) {
      logger.info(`ENGINE: Match ${matchId} has 2 players. Starting Race...`);
      const now = Date.now();
      const endTime = now + preMatch.duration;
      const updatedGame = await MatchModel.findOneAndUpdate(
        { matchId, status: "WAITING" },
        { $set: { status: "RACING", startTime: now, endTime } },
        { new: true }
      );
      if (updatedGame) {
        logger.info(`RACE STARTED! Ends at: ${new Date(endTime).toISOString()}`);
        if (streams.match) {
          await streams.match.set(matchId, "message", {
            type: "START_RACE",
            startTime: now,
            endTime
          });
        }
        await emit({
          topic: "match.started",
          data: { matchId, duration: preMatch.duration }
        });
      }
    }
  }
  if (isCodeEvent) {
    const result = payload;
    logger.info(`ENGINE: Result for ${matchId} (${result.action}) - Success: ${result.success}`);
    if (streams.match) {
      await streams.match.set(matchId, "message", {
        type: "CODE_FEEDBACK",
        playerId: result.playerId,
        action: result.action,
        success: result.success,
        error: result.error,
        results: result.results,
        timestamp: Date.now()
      });
    }
    if (result.action === "SUBMIT_SOLUTION" && result.success) {
      const winningGame = await MatchModel.findOneAndUpdate(
        { matchId, status: "RACING" },
        { $set: { status: "FINISHED", winnerId: result.playerId } },
        { new: true }
      );
      if (winningGame) {
        logger.info(`MATCH FINISHED! Winner is ${result.playerId}`);
        if (streams.match) {
          await streams.match.set(matchId, "message", {
            type: "GAME_OVER",
            winner: result.playerId,
            reason: "SOLVED"
          });
        }
      }
    }
  }
};
export {
  config,
  handler
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vZ2FtZS1lbmdpbmUuc3RlcC50cyJdLAogICJzb3VyY2VzQ29udGVudCI6IFsiaW1wb3J0IHsgU3RlcENvbmZpZyB9IGZyb20gJ21vdGlhJztcclxuaW1wb3J0IHsgY29ubmVjdERCIH0gZnJvbSAnLi4vc3JjL2RiJztcclxuaW1wb3J0IHsgTWF0Y2hNb2RlbCB9IGZyb20gJy4uL3NyYy9tb2RlbHMvTWF0Y2gnO1xyXG5cclxuZXhwb3J0IGNvbnN0IGNvbmZpZzogU3RlcENvbmZpZyA9IHtcclxuICBuYW1lOiAnR2FtZUVuZ2luZScsXHJcbiAgdHlwZTogJ2V2ZW50JyxcclxuICBzdWJzY3JpYmVzOiBbJ3BsYXllci5qb2luZWQnLCAnY29kZS5wcm9jZXNzZWQnXSxcclxuICBlbWl0czogWydtYXRjaC5zdGFydGVkJ10sIC8vIFx1RDgzRFx1REM0OCBORVc6IFRyaWdnZXJzIHRoZSB0aW1lclxyXG4gIGZsb3dzOiBbJ0NvZGVEdWVsRmxvdyddXHJcbn07XHJcblxyXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChldmVudDogYW55LCBjb250ZXh0OiBhbnkpID0+IHtcclxuICBjb25zdCB7IHN0cmVhbXMsIGxvZ2dlciwgdG9waWMsIGVtaXQgfSA9IGNvbnRleHQ7IFxyXG4gIGF3YWl0IGNvbm5lY3REQigpO1xyXG4gIFxyXG4gIGNvbnN0IHBheWxvYWQgPSBldmVudC5kYXRhIHx8IGV2ZW50OyBcclxuICBjb25zdCBtYXRjaElkID0gcGF5bG9hZC5tYXRjaElkO1xyXG5cclxuICBpZiAoIW1hdGNoSWQpIHtcclxuICAgIGxvZ2dlci5lcnJvcihcIkVOR0lORTogTWlzc2luZyBtYXRjaElkIGluIGV2ZW50XCIsIHBheWxvYWQpO1xyXG4gICAgcmV0dXJuO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgaXNKb2luRXZlbnQgPSAodG9waWMgPT09ICdwbGF5ZXIuam9pbmVkJykgfHwgKHBheWxvYWQucGxheWVySWQgJiYgIXBheWxvYWQuYWN0aW9uKTtcclxuICBjb25zdCBpc0NvZGVFdmVudCA9ICh0b3BpYyA9PT0gJ2NvZGUucHJvY2Vzc2VkJykgfHwgKHBheWxvYWQuYWN0aW9uICE9PSB1bmRlZmluZWQpO1xyXG5cclxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuICAvLyAxLiBQTEFZRVIgSk9JTiAmIFJBQ0UgU1RBUlQgTE9HSUNcclxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuICBpZiAoaXNKb2luRXZlbnQpIHtcclxuICAgIGNvbnN0IHByZU1hdGNoID0gYXdhaXQgTWF0Y2hNb2RlbC5maW5kT25lKHsgbWF0Y2hJZCB9KTtcclxuICAgIFxyXG4gICAgLy8gQ2hlY2sgaWYgd2UgYXJlIHdhaXRpbmcgYW5kIG5vdyBoYXZlIGVub3VnaCBwbGF5ZXJzICgyKVxyXG4gICAgaWYgKHByZU1hdGNoICYmIHByZU1hdGNoLnN0YXR1cyA9PT0gJ1dBSVRJTkcnICYmIHByZU1hdGNoLnBsYXllcnMubGVuZ3RoID49IDIpIHtcclxuICAgICAgICBsb2dnZXIuaW5mbyhgRU5HSU5FOiBNYXRjaCAke21hdGNoSWR9IGhhcyAyIHBsYXllcnMuIFN0YXJ0aW5nIFJhY2UuLi5gKTtcclxuXHJcbiAgICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcclxuICAgICAgICBjb25zdCBlbmRUaW1lID0gbm93ICsgcHJlTWF0Y2guZHVyYXRpb247XHJcblxyXG4gICAgICAgIGNvbnN0IHVwZGF0ZWRHYW1lID0gYXdhaXQgTWF0Y2hNb2RlbC5maW5kT25lQW5kVXBkYXRlKFxyXG4gICAgICAgICAgICB7IG1hdGNoSWQsIHN0YXR1czogJ1dBSVRJTkcnIH0sXHJcbiAgICAgICAgICAgIHsgJHNldDogeyBzdGF0dXM6ICdSQUNJTkcnLCBzdGFydFRpbWU6IG5vdywgZW5kVGltZTogZW5kVGltZSB9IH0sXHJcbiAgICAgICAgICAgIHsgbmV3OiB0cnVlIH1cclxuICAgICAgICApO1xyXG5cclxuICAgICAgICBpZiAodXBkYXRlZEdhbWUpIHtcclxuICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGBSQUNFIFNUQVJURUQhIEVuZHMgYXQ6ICR7bmV3IERhdGUoZW5kVGltZSkudG9JU09TdHJpbmcoKX1gKTtcclxuICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgLy8gQS4gQnJvYWRjYXN0IFNUQVJUIHRvIEZyb250ZW5kXHJcbiAgICAgICAgICAgICBpZiAoc3RyZWFtcy5tYXRjaCkge1xyXG4gICAgICAgICAgICAgICAgYXdhaXQgc3RyZWFtcy5tYXRjaC5zZXQobWF0Y2hJZCwgJ21lc3NhZ2UnLCB7IFxyXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdTVEFSVF9SQUNFJywgXHJcbiAgICAgICAgICAgICAgICAgICAgc3RhcnRUaW1lOiBub3csIFxyXG4gICAgICAgICAgICAgICAgICAgIGVuZFRpbWU6IGVuZFRpbWUgXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAvLyBCLiBTdGFydCB0aGUgRHVyYWJsZSBUaW1lciAoUmVwbGFjZXMgQ3JvbilcclxuICAgICAgICAgICAgIGF3YWl0IGVtaXQoeyBcclxuICAgICAgICAgICAgICAgICB0b3BpYzogJ21hdGNoLnN0YXJ0ZWQnLCBcclxuICAgICAgICAgICAgICAgICBkYXRhOiB7IG1hdGNoSWQsIGR1cmF0aW9uOiBwcmVNYXRjaC5kdXJhdGlvbiB9IFxyXG4gICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcbiAgLy8gMi4gQ09ERSBFWEVDVVRJT04gRkVFREJBQ0sgJiBXSU4gTE9HSUNcclxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuICBpZiAoaXNDb2RlRXZlbnQpIHtcclxuICAgICBjb25zdCByZXN1bHQgPSBwYXlsb2FkOyBcclxuICAgICBsb2dnZXIuaW5mbyhgRU5HSU5FOiBSZXN1bHQgZm9yICR7bWF0Y2hJZH0gKCR7cmVzdWx0LmFjdGlvbn0pIC0gU3VjY2VzczogJHtyZXN1bHQuc3VjY2Vzc31gKTtcclxuXHJcbiAgICAgLy8gQWx3YXlzIFN0cmVhbSBGZWVkYmFja1xyXG4gICAgIGlmIChzdHJlYW1zLm1hdGNoKSB7XHJcbiAgICAgICAgIGF3YWl0IHN0cmVhbXMubWF0Y2guc2V0KG1hdGNoSWQsICdtZXNzYWdlJywgeyBcclxuICAgICAgICAgICAgdHlwZTogJ0NPREVfRkVFREJBQ0snLFxyXG4gICAgICAgICAgICBwbGF5ZXJJZDogcmVzdWx0LnBsYXllcklkLFxyXG4gICAgICAgICAgICBhY3Rpb246IHJlc3VsdC5hY3Rpb24sXHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHJlc3VsdC5zdWNjZXNzLFxyXG4gICAgICAgICAgICBlcnJvcjogcmVzdWx0LmVycm9yLFxyXG4gICAgICAgICAgICByZXN1bHRzOiByZXN1bHQucmVzdWx0cyxcclxuICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpXHJcbiAgICAgICAgIH0pO1xyXG4gICAgIH1cclxuXHJcbiAgICAgLy8gSGFuZGxlIFdpbiBDb25kaXRpb25cclxuICAgICBpZiAocmVzdWx0LmFjdGlvbiA9PT0gJ1NVQk1JVF9TT0xVVElPTicgJiYgcmVzdWx0LnN1Y2Nlc3MpIHtcclxuICAgICAgICAvLyBBdG9taWMgV2luIENsYWltXHJcbiAgICAgICAgY29uc3Qgd2lubmluZ0dhbWUgPSBhd2FpdCBNYXRjaE1vZGVsLmZpbmRPbmVBbmRVcGRhdGUoXHJcbiAgICAgICAgICAgIHsgbWF0Y2hJZCwgc3RhdHVzOiAnUkFDSU5HJyB9LFxyXG4gICAgICAgICAgICB7ICRzZXQ6IHsgc3RhdHVzOiAnRklOSVNIRUQnLCB3aW5uZXJJZDogcmVzdWx0LnBsYXllcklkIH0gfSxcclxuICAgICAgICAgICAgeyBuZXc6IHRydWUgfVxyXG4gICAgICAgICk7XHJcblxyXG4gICAgICAgIGlmICh3aW5uaW5nR2FtZSkge1xyXG4gICAgICAgICAgICBsb2dnZXIuaW5mbyhgTUFUQ0ggRklOSVNIRUQhIFdpbm5lciBpcyAke3Jlc3VsdC5wbGF5ZXJJZH1gKTtcclxuICAgICAgICAgICAgaWYgKHN0cmVhbXMubWF0Y2gpIHtcclxuICAgICAgICAgICAgICAgIGF3YWl0IHN0cmVhbXMubWF0Y2guc2V0KG1hdGNoSWQsICdtZXNzYWdlJywgeyBcclxuICAgICAgICAgICAgICAgICAgICB0eXBlOiAnR0FNRV9PVkVSJywgXHJcbiAgICAgICAgICAgICAgICAgICAgd2lubmVyOiByZXN1bHQucGxheWVySWQsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVhc29uOiAnU09MVkVEJ1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgfVxyXG4gIH1cclxufTsiXSwKICAibWFwcGluZ3MiOiAiQUFDQSxTQUFTLGlCQUFpQjtBQUMxQixTQUFTLGtCQUFrQjtBQUVwQixNQUFNLFNBQXFCO0FBQUEsRUFDaEMsTUFBTTtBQUFBLEVBQ04sTUFBTTtBQUFBLEVBQ04sWUFBWSxDQUFDLGlCQUFpQixnQkFBZ0I7QUFBQSxFQUM5QyxPQUFPLENBQUMsZUFBZTtBQUFBO0FBQUEsRUFDdkIsT0FBTyxDQUFDLGNBQWM7QUFDeEI7QUFFTyxNQUFNLFVBQVUsT0FBTyxPQUFZLFlBQWlCO0FBQ3pELFFBQU0sRUFBRSxTQUFTLFFBQVEsT0FBTyxLQUFLLElBQUk7QUFDekMsUUFBTSxVQUFVO0FBRWhCLFFBQU0sVUFBVSxNQUFNLFFBQVE7QUFDOUIsUUFBTSxVQUFVLFFBQVE7QUFFeEIsTUFBSSxDQUFDLFNBQVM7QUFDWixXQUFPLE1BQU0sb0NBQW9DLE9BQU87QUFDeEQ7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
